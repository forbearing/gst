# This workflow builds and validates a Go project
# It checks formatting, builds the project, and verifies that the generated demo project compiles

name: Go

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      # Cache Go modules and build cache
      - name: Cache Go dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # Install gofumpt for formatting checks
      - name: Install gofumpt
        run: go install mvdan.cc/gofumpt@v0.9.2

      # Check if code is properly formatted
      - name: Check formatting
        run: |
          files=$(gofumpt -l .)
          if [ -n "$files" ]; then
            echo "âŒ gofumpt found unformatted files:"
            echo "$files"
            echo ""
            echo "ðŸ‘‰ Please run 'gofumpt -w .' locally and commit again."
            exit 1
          else
            echo "âœ… gofumpt formatting check passed"
          fi

      # Install and run golangci-lint
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.6.2

      - name: Run golangci-lint
        run: golangci-lint run ./...

      # Install and run shadow analysis
      - name: Install shadow
        run: go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow@v0.38.0

      - name: Run shadow analysis
        run: shadow ./...

      # Install and run modernize analysis
      - name: Install modernize
        run: go install golang.org/x/tools/go/analysis/passes/modernize/cmd/modernize@v0.38.0

      - name: Run modernize analysis
        run: modernize ./...

      # Build the current project
      - name: Build project
        run: go build -v ./...

      # Install gg CLI
      - name: Install gg CLI
        run: go install ./cmd/gg

      # Generate demo project
      - name: Generate demo project
        run: gg new demo

      # Add user model to demo project
      - name: Add user model
        run: |
          cat > demo/model/user.go <<'EOF'
          package model

          import (
            . "github.com/forbearing/gst/dsl"
            "github.com/forbearing/gst/model"
          )

          type User struct {
            Name string
            Age  string

            model.Base
          }

          func (User) Design() {
            Migrate(true)

            Create(func() {
              Enabled(true)
            })
            Delete(func() {
              Enabled(true)
            })
            Update(func() {
              Enabled(true)
            })
            Patch(func() {
              Enabled(true)
            })
            List(func() {
              Enabled(true)
            })
            Get(func() {
              Enabled(true)
            })
            CreateMany(func() {
              Enabled(true)
            })
            DeleteMany(func() {
              Enabled(true)
            })
            UpdateMany(func() {
              Enabled(true)
            })
            PatchMany(func() {
              Enabled(true)
            })
          }
          EOF

      # Run gg gen inside demo project
      - name: Run gg gen
        run: |
          cd demo
          gg gen

      # Ensure the generated demo project compiles
      - name: Build demo project
        run: go build -C demo ./...
